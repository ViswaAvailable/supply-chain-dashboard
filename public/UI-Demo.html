<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ManufacturingOS - Smart Inventory Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            padding-bottom: 24px;
            border-bottom: 1px solid #475569;
        }

        .logo i {
            font-size: 32px;
            color: #3b82f6;
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #cbd5e1;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: #475569;
            color: white;
        }

        .nav-link.active {
            background: #3b82f6;
            color: white;
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
        }

        .page-subtitle {
            font-size: 16px;
            color: #64748b;
            margin-top: 4px;
        }

        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .status-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .status-card-title {
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
        }

        .status-card-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .status-card-change {
            font-size: 12px;
            font-weight: 500;
        }

        .status-card-change.positive { color: #059669; }
        .status-card-change.negative { color: #dc2626; }

        .calendar-grid {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .calendar-nav button {
            padding: 8px 12px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: #e2e8f0;
        }

        .calendar-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .legend {
            display: flex;
            gap: 24px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .weeks-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .week-day {
            background: #f8fafc;
            padding: 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
        }

        .week-cell {
            background: white;
            padding: 16px 12px;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .week-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .week-number {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
        }

        .week-status {
            width: 100%;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }

        .status-good { background: #059669; }
        .status-warning { background: #d97706; }
        .status-critical { background: #dc2626; }

        .week-details {
            position: absolute;
            bottom: 4px;
            left: 12px;
            right: 12px;
            font-size: 10px;
            color: #64748b;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .table-header {
            background: #f8fafc;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 24px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        td {
            font-size: 14px;
            color: #1e293b;
        }

        tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        .supplier-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
        }

        .supplier-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .supplier-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .supplier-info h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .supplier-info p {
            font-size: 14px;
            color: #64748b;
        }

        .supplier-rating {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rating-score {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .rating-stars {
            color: #fbbf24;
        }

        .supplier-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .metric {
            text-align: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .metric-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .parts-list {
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
        }

        .parts-list h4 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .parts-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .part-tag {
            padding: 4px 8px;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        /* --- Modal overlay and content panel --- */
        .modal-content {
            background: white;
            padding: 0; /* Let header/body control padding */
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: clamp(320px, 90vw, 800px); /* Responsive width */
            max-height: 85vh; /* Increased max-height */
            overflow: hidden; /* Hide scrollbars on content, body will handle it */
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }

        /* --- KPI Trend Colors --- */
        .trend-up { color: #28a745; }
        .trend-down { color: #d9534f; }
        .trend-neutral { color: #ffc107; }
        .kpi-sublabel {
            display: block;
            color: #94a3b8;
            font-size: 80%;
            margin-top: 2px;
            font-weight: 400;
        }
        /* --- Week Tile Grid --- */
        .week-tile{all:unset;display:flex;flex-direction:column;align-items:center;justify-content:space-between;
        border:1px solid #e2e8f0;border-radius:10px;padding:18px 12px;width:100%;height:110px;
        cursor:pointer;background:#fff;transition:transform .15s,box-shadow .15s;}
        .week-tile:hover,.week-tile:focus{transform:scale(1.02);box-shadow:0 4px 14px rgba(0,0,0,.1);}
        .week-tile.on-track {background:#eafae4;}
        .week-tile.at-risk {background:#fff4e5;}
        .week-tile.critical {background:#fde8e8;}
        .status-pill{padding:4px 12px;border-radius:12px;font-size:13px;color:#fff;font-weight:600;}
        .week-tile.on-track .status-pill{background:#059669;}
        .week-tile.at-risk .status-pill{background:#d97706;}
        .week-tile.critical .status-pill{background:#dc2626;}
        .issue-icon{font-size:20px;margin-top:4px;}
        /* Weekly grid container rule (spec: after .week-tile) */
        .weekly-status-grid{
          display:grid;
          grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
          gap:16px;
          margin-top:24px;
        }
        .week-label      {display:flex;flex-direction:column;line-height:1.2;}
        .week-num        {font-weight:600;font-size:.95rem;}
        .week-date       {font-size:.70rem;color:#6b7280;margin-top:2px;}
        @media(max-width:640px){
          .week-label{flex-direction:row;gap:4px;}
        }
        /* Critical tiles pull attention */
        .week-tile.critical{box-shadow:0 0 0 2px #ef4444;}
        /* Modal specific */
        .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
        background:rgba(0,0,0,.45);z-index:2000;}
        .modal-header{
          display:flex;justify-content:space-between;align-items:center;
          position:sticky;top:0;background:#fff;z-index:2;padding:12px 16px;
          border-bottom:1px solid #e5e7eb;
          flex-shrink: 0; /* Prevent header from shrinking */
        }
        .modal-actions button{margin-left:8px;}
        .btn-icon{background:none;border:none;font-size:1.1rem;cursor:pointer;color:#475569;}
        .modal-body{
            max-height:70vh;
            overflow:auto;
            padding: 16px; /* Restore padding for body */
        }
        .modal .root-cause{width:100%;border-collapse:collapse;font-size:14px;}
        .modal .root-cause th,.modal .root-cause td{padding:8px 10px;border-bottom:1px solid #e2e8f0;}
        .modal .root-cause tr.critical{background:#ffe6e6;}
        td.shortfall.negative{color:#b91c1c;font-weight:600;}
        button.primary,button.ghost{border:none;}
        button.primary {background:#3b82f6;color:#fff;padding:8px 16px;border-radius:6px;}
        button.secondary {background:#f1f5f9;color:#374151;padding:8px 16px;border:1px solid #d1d5db;}
        button.ghost {background:none;color:#475569;padding:8px 16px;border:none;}
        /* --- new modal action buttons (matches old colour scheme) --- */
        .btn-primary{
          background:#3b82f6;
          color:#fff;
          padding:8px 16px;
          border-radius:6px;
          border:none;
        }
        .btn-secondary{
          background:#f1f5f9;
          color:#374151;
          padding:8px 16px;
          border:1px solid #d1d5db;
        }
        .btn-icon{
          background:none;
          border:none;
          font-size:1.1rem;
          color:#475569;
          cursor:pointer;
        }
        /* legacy aliases – keep for other pages */
        button.primary{
          background:#3b82f6;
          color:#fff;
          padding:8px 16px;
          border-radius:6px;
          border:none;
        }
        button.secondary{
          background:#f1f5f9;
          color:#374151;
          padding:8px 16px;
          border:1px solid #d1d5db;
        }
        button.ghost{
          background:none;
          color:#475569;
          padding:8px 16px;
          border:none;
        }
        /* --- Weekly Status Grid --- */
        .weekly-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 24px;
            margin-bottom: 24px;
        }
        .weekly-status-cell {
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            padding: 18px 12px 12px 12px;
            text-align: center;
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s;
            position: relative;
        }
        .weekly-status-cell:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.10);
            transform: translateY(-2px);
        }
        .weekly-status-label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 6px;
        }
        .weekly-status-indicator {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        .weekly-status-good { background: #059669; }
        .weekly-status-warning { background: #d97706; }
        .weekly-status-critical { background: #dc2626; }
        .weekly-status-details {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 8px;
        }
        /* Modal for Weekly Details */
        .weekly-modal-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 18px;
        }
        .weekly-modal-table th, .weekly-modal-table td {
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 10px;
            font-size: 14px;
            text-align: left;
        }
        .weekly-modal-table th {
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
        }
        .weekly-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 8px;
        }
        .weekly-modal-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }
        .weekly-modal-btn-primary {
            background: #3b82f6;
            color: white;
        }
        .weekly-modal-btn-secondary {
            background: #f1f5f9;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .weekly-modal-btn-secondary:hover {
            background: #e2e8f0;
        }
        .weekly-modal-close-x {
            background: none;
            border: none;
            font-size: 22px;
            color: #64748b;
            cursor: pointer;
        }

        /* --- Parts Planning Table Enhancements --- */
        .parts-table-container th .sort-icon {
            opacity: 0.4;
            display: inline-block;
            transition: opacity 0.2s;
        }
        .parts-table-container th:hover .sort-icon {
            opacity: 1;
        }
        .parts-table-container .actions-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px; /* Prevent layout shift */
        }
        .parts-table-container .btn-icon-sm {
            background: none;
            border: 1px solid transparent;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
        }
        .parts-table-container .btn-icon-sm:hover {
            border-color: #d1d5db;
        }
        /* --- Parts Planning Table Enhancements --- */
        .parts-table-container {
            overflow: auto; /* Enable x/y scrolling */
            max-height: calc(100vh - 320px); /* Fit table in viewport */
            outline: none; /* Hide focus ring on container itself */
        }
        .parts-table-container table {
            border-collapse: separate; /* Required for sticky styles */
            border-spacing: 0;
        }
        .parts-table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8fafc; /* Match original header bg */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        /* --- Sticky First Two Columns --- */
        .parts-table-container th:nth-child(1), .parts-table-container td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 5;
            background: #f8fafc;
            width: 50px;
            min-width: 50px;
        }
        .parts-table-container td:nth-child(1) {
            background: white;
        }
        .parts-table-container tr:hover td:nth-child(1) {
            background: #f8fafc;
        }
        .parts-table-container th:nth-child(2), .parts-table-container td:nth-child(2) {
            position: sticky;
            left: 50px; /* Width of first column */
            z-index: 5;
            background: #f8fafc;
        }
        .parts-table-container td:nth-child(2) {
            background: white;
        }
        .parts-table-container tr:hover td:nth-child(2) {
            background: #f8fafc;
        }
        /* Corner cells need highest z-index */
        .parts-table-container thead th:nth-child(1), .parts-table-container thead th:nth-child(2) {
            z-index: 15;
        }

        .parts-table-container th .sort-icon {
            opacity: 0.4;
            display: inline-block;
            transition: opacity 0.2s;
        }
        .parts-table-container th:hover .sort-icon {
            opacity: 1;
        }
        .parts-table-container .actions-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px; /* Prevent layout shift */
        }
        .parts-table-container .btn-icon-sm {
            background: none;
            border: 1px solid transparent;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
        }
        .parts-table-container .btn-icon-sm:hover {
            border-color: #d1d5db;
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .weeks-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .supplier-cards {
                grid-template-columns: 1fr;
            }
        }
        @media(max-width:720px){
          .weekly-status-grid{grid-template-columns:1fr;}
          .calendar-header .legend{display:none;}
        }
        /* --- Supplier Card Enhancements --- */
        .supplier-card {
            border-left: 4px solid #6b7280; /* Default border */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .supplier-card.border-success { border-left-color: #28a745; }
        .supplier-card.border-primary { border-left-color: #3b82f6; }
        .supplier-card.border-danger { border-left-color: #d9534f; }

        .rating-trend {
            font-size: 14px;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .rating-trend.trend-up { color: #28a745; }
        .rating-trend.trend-down { color: #d9534f; }
        .rating-trend.trend-neutral { color: #6b7280; }

        .supplier-card-footer {
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
            margin-top: 16px;
        }

        /* --- Analytics Page Enhancements --- */
        .chart-header-filter {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chart-header-filter label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        @media (max-width: 1024px) {
            .data-table .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* --- Supplier Card Enhancements --- */
        .supplier-card {
            border-left: 4px solid #6b7280; /* Default border */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .supplier-card.border-success { border-left-color: #28a745; }
        .supplier-card.border-primary { border-left-color: #3b82f6; }
        .supplier-card.border-danger { border-left-color: #d9534f; }

        .rating-trend {
            font-size: 14px;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .rating-trend.trend-up { color: #28a745; }
        .rating-trend.trend-down { color: #d9534f; }
        .rating-trend.trend-neutral { color: #6b7280; }

        .supplier-card-footer {
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
            margin-top: 16px;
        }

        .action-popover {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 20;
            padding: 8px 0;
            min-width: 200px;
            list-style: none;
            margin: 4px 0 0 0;
        }
        .action-popover li {
            padding: 8px 16px;
            cursor: pointer;
        }
        .action-popover li:hover {
            background: #f1f5f9;
        }

        .actions-menu {
            position: absolute; /* detach from table flow */
            top: calc(100% + 4px); /* 4px gap below the button */
            right: 0; /* align on the button's right edge */
            min-width: 160px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,.08);
            z-index: 1000; /* higher than table / modals */
            padding: 4px 0;
            list-style: none;
            margin: 0;
        }
        .actions-menu button { /* individual menu items */
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }
        .actions-menu button:hover {
            background: #f1f5f9;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-industry"></i>
                <h1>ManufacturingOS</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-page="overview" href="#overview">
                        <i class="fas fa-calendar-alt"></i>
                        Assembly Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="parts" href="#parts">
                        <i class="fas fa-cogs"></i>
                        Parts Planning
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="suppliers" href="#suppliers">
                        <i class="fas fa-truck"></i>
                        Supplier Performance
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="analytics" href="#analytics">
                        <i class="fas fa-chart-line"></i>
                        Analytics & KPIs
                    </a>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- Assembly Overview Page -->
            <div class="page active" id="overview">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Assembly Overview</h1>
                        <p class="page-subtitle">Weekly production status and inventory risk assessment</p>
                    </div>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Final Product</label>
                        <select class="filter-select">
                            <option>All Products</option>
                            <option>Widget Assembly A</option>
                            <option>Widget Assembly B</option>
                            <option>Motor Unit X</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Time Range</label>
                        <select class="filter-select">
                            <option>Next 12 Weeks</option>
                            <option>Next 8 Weeks</option>
                            <option>Next 16 Weeks</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">View</label>
                        <select class="filter-select">
                            <option>All Risk Levels</option>
                            <option>High Risk Only</option>
                            <option>Good Status Only</option>
                        </select>
                    </div>
                </div>

                <div class="status-cards">
                    <div class="status-card">
                        <div class="status-card-header">
                            <span class="status-card-title">Weeks at Risk
                                <small class="kpi-sublabel">(Next 12 weeks)</small>
                            </span>
                            <i class="fas fa-exclamation-triangle" style="color: #d97706;"></i>
                        </div>
                        <div class="status-card-value">3</div>
                        <div class="status-card-change trend-down">↑ 2 from last month</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-header">
                            <span class="status-card-title">Parts Requiring PO
                                <small class="kpi-sublabel">(All open POs)</small>
                            </span>
                            <i class="fas fa-shopping-cart" style="color: #3b82f6;"></i>
                        </div>
                        <div class="status-card-value">12</div>
                        <div class="status-card-change trend-up">↓ 5 from last week</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-header">
                            <span class="status-card-title">Avg. Lead Time
                                <small class="kpi-sublabel">(All active parts)</small>
                            </span>
                            <i class="fas fa-clock" style="color: #059669;"></i>
                        </div>
                        <div class="status-card-value">8.4<span style="font-size: 14px; color: #64748b;"> days</span></div>
                        <div class="status-card-change trend-up">↓ 0.6 days</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-header">
                            <span class="status-card-title">Supplier Performance
                                <small class="kpi-sublabel">(Last 30 days)</small>
                            </span>
                            <i class="fas fa-star" style="color: #fbbf24;"></i>
                        </div>
                        <div class="status-card-value">87%</div>
                        <div class="status-card-change trend-up">↑ 3% this month</div>
                    </div>
                </div>

                <div class="calendar-grid">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button aria-label="Previous month" onclick="changeMonth(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h2 class="calendar-title" id="currentMonth">January 2024</h2>
                            <button aria-label="Next month" onclick="changeMonth(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color status-good"></div>
                                <span>On Track</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color status-warning"></div>
                                <span>At Risk</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color status-critical"></div>
                                <span>Critical Risk</span>
                            </div>
                        </div>
                    </div>
                    <div class="weekly-status-grid" id="weeklyStatusGrid"></div>
                    </div>
                <!-- Modal template for Week Details (lazy-injected) -->
                <template id="weekModalTemplate">
                  <div id="weekModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
                    <div class="modal-content">
                        <header class="modal-header">
                          <h3 id="modalTitle">Week X Details: Status</h3>
                          <button class="btn-icon" data-dismiss="modal" aria-label="Close dialog">✕</button>
                        </header>
                        <div class="modal-body">
                            <!-- Table will go here -->
                        </div>
                    </div>
                  </div>
                </template>
                <!-- Modal for Weekly Details -->
            </div>

            <!-- Parts Planning Page -->
            <div class="page" id="parts">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Parts Planning</h1>
                        <p class="page-subtitle">Inventory management and purchase order recommendations</p>
                    </div>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Part Category</label>
                        <select class="filter-select">
                            <option>All Categories</option>
                            <option>Electronic Components</option>
                            <option>Mechanical Parts</option>
                            <option>Raw Materials</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Supplier</label>
                        <select class="filter-select">
                            <option>All Suppliers</option>
                            <option>TechCorp Industries</option>
                            <option>MechParts Ltd</option>
                            <option>GlobalSupply Co</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select class="filter-select">
                            <option>All Status</option>
                            <option>PO Required</option>
                            <option>Low Stock</option>
                            <option>Overstocked</option>
                        </select>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Parts Inventory & PO Recommendations</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary">Export</button>
                            <button class="btn btn-primary" id="bulkPOBtn" disabled>Bulk PO Generation</button>
                            <div id="bulkActionsContainer" style="position: relative; display: none;">
                                <button class="btn btn-secondary" id="bulkActionsBtn" aria-haspopup="true" aria-expanded="false">Actions (0)</button>
                                <ul id="bulkActionsMenu" class="actions-menu" style="display: none;" role="menu">
                                    <li><button id="assignCategoryBtn" role="menuitem">Assign Category…</button></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="parts-table-container" tabindex="0">
                    <table>
                        <thead>
                            <tr>
                                    <th><input type="checkbox" id="selectAllPartsCheckbox" aria-label="Select all parts"></th>
                                <th>Part Number</th>
                                <th>Description</th>
                                <th>Current Stock</th>
                                <th>Safety Stock</th>
                                <th>Lead Time</th>
                                <th>MOQ</th>
                                <th>Supplier</th>
                                    <th>Recommended Order Qty</th>
                                <th>Status</th>
                                    <th data-sort="weeksOfStock">Weeks of Stock <span class="sort-icon"></span></th>
                                    <th data-sort="onOrderQty">On Order Qty <span class="sort-icon"></span></th>
                                    <th data-sort="nextArrival">Next Arrival <span class="sort-icon"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partsTable">
                            <!-- Generated dynamically -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Supplier Performance Page -->
            <div class="page" id="suppliers">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Supplier Performance</h1>
                        <p class="page-subtitle">Analyze and track supplier reliability and performance metrics</p>
                    </div>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Region</label>
                        <select class="filter-select">
                            <option>All Regions</option>
                            <option>Asia Pacific</option>
                            <option>Europe</option>
                            <option>North America</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Performance</label>
                        <select class="filter-select">
                            <option>All Performance</option>
                            <option>Excellent (90%+)</option>
                            <option>Good (80-89%)</option>
                            <option>Needs Improvement (<80%)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Time Period</label>
                        <select class="filter-select">
                            <option>Last 6 Months</option>
                            <option>Last 3 Months</option>
                            <option>Last 12 Months</option>
                        </select>
                    </div>
                </div>

                <div class="supplier-cards" id="supplierCards">
                    <!-- Generated dynamically -->
                </div>
            </div>

            <!-- Analytics & KPIs Page -->
            <div class="page" id="analytics">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Analytics & KPIs</h1>
                        <p class="page-subtitle">Key performance indicators and business intelligence</p>
                    </div>
                </div>

                <div class="status-cards">
                    <div class="status-card">
                        <div class="status-card-header">
                            <span class="status-card-title">Inventory Turnover</span>
                            <i class="fas fa-sync-alt" style="color: #3b82f6;"></i>
                        </div>
                        <div class="status-card-value">4.2x</div>
                        <div class="status-card-change positive">↑ 0.3x vs target</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-header">
                            <span class="status-card-title">Stockout Prevention</span>
                            <i class="fas fa-shield-alt" style="color: #059669;"></i>
                        </div>
                        <div class="status-card-value">96.7%</div>
                        <div class="status-card-change positive">↑ 2.1% this quarter</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">Lead Time Trends</h3>
                            <div class="chart-header-filter">
                                <div class="filter-group">
                                    <label for="leadTimePrimary">View by:</label>
                                    <select id="leadTimePrimary" class="filter-select" aria-label="Select lead-time grouping dimension">
                                        <option value="partCategory">Part Category</option>
                                        <option value="finalProduct">Final Product</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="leadTimeSecondary" id="leadTimeSecondaryLabel">Select Category:</label>
                                    <select id="leadTimeSecondary" class="filter-select" aria-label="Select lead-time filter value"></select>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div id="leadTimeAnnouncer" aria-live="polite" class="sr-only"></div>
                            <canvas id="leadTimeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">Supplier Performance Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="supplierChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Monthly Inventory Value</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="inventoryChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Part Detail Modal Template -->
    <template id="partDetailModalTemplate">
        <div id="partDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="partDetailModalTitle">
        <div class="modal-content">
                <header class="modal-header">
                    <h3 id="partDetailModalTitle">Part Details</h3>
                    <button class="btn-icon" data-dismiss="modal" aria-label="Close dialog">✕</button>
                </header>
                <div class="modal-body" id="partDetailModalBody">
                    <!-- Part details injected here -->
            </div>
            </div>
        </div>
    </template>

    <!-- Modal template for Bulk PO Confirmation -->
    <template id="bulkPOModalTemplate">
      <div id="bulkPOModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bulkPOModalTitle">
        <div class="modal-content">
          <header class="modal-header">
            <h3 id="bulkPOModalTitle">Confirm Bulk Purchase Order</h3>
            <button class="btn-icon" data-dismiss="modal" aria-label="Close dialog">✕</button>
          </header>
          <div class="modal-body">
            <p>Please review the following parts for PO generation:</p>
            <table class="root-cause" id="bulkPOTable">
              <thead>
                <tr><th>Part ID</th><th>Supplier</th><th>Required Qty</th><th>Current Stock</th><th>Weeks of Stock</th></tr>
              </thead>
              <tbody></tbody>
            </table>
            <footer>
              <button class="btn-primary" id="confirmBulkPO">Confirm & Create POs</button>
              <button class="btn-secondary" data-dismiss="modal">Cancel</button>
            </footer>
    </div>
        </div>
      </div>
    </template>

    <!-- Modal template for Bulk Category Assignment -->
    <template id="assignCategoryModalTemplate">
      <div id="assignCategoryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="assignCategoryModalTitle">
        <div class="modal-content">
          <header class="modal-header">
            <h3 id="assignCategoryModalTitle">Assign Category</h3>
            <button class="btn-icon" data-dismiss="modal" aria-label="Close dialog">✕</button>
          </header>
          <div class="modal-body" style="padding: 16px;">
              <div class="filter-group">
                  <label for="bulkCategorySelector" style="font-weight: 500;">Select a category to assign:</label>
                  <select id="bulkCategorySelector" class="filter-select" aria-label="Part Category selector"></select>
              </div>
          </div>
          <footer style="padding: 16px; display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid #e2e8f0;">
              <button class="btn-secondary" data-dismiss="modal">Cancel</button>
              <button class="btn-primary" id="applyCategoryBtn">Apply</button>
          </footer>
        </div>
      </div>
    </template>

    <script>
        // Mock Data
        const mockParts = [
            {
                partNumber: "PCB-001", description: "Main Circuit Board", currentStock: 45, safetyStock: 20, leadTime: "12 days", moq: 100, supplier: "TechCorp Industries", recommendedQty: 100, status: "PO Required", price: 25.50, avgWeeklyConsumption: 10, onOrderQty: 100, nextArrival: '2024-03-15', partCategory: "Processors", finalProduct: "Widget Assembly A", monthlyLeadTimes: [12, 13, 12, 11, 12, 11]
            },
            {
                partNumber: "MTR-205", description: "AC Motor 5HP", currentStock: 8, safetyStock: 15, leadTime: "21 days", moq: 25, supplier: "MechParts Ltd", recommendedQty: 25, status: "Critical", price: 340.00, avgWeeklyConsumption: 5, onOrderQty: 25, nextArrival: '2024-03-22', partCategory: "Motors", finalProduct: "Motor Unit X", monthlyLeadTimes: [21, 22, 20, 21, 22, 21]
            },
            {
                partNumber: "BRG-034", description: "Ball Bearing 34mm", currentStock: 150, safetyStock: 50, leadTime: "7 days", moq: 200, supplier: "GlobalSupply Co", recommendedQty: 0, status: "Good", price: 12.75, avgWeeklyConsumption: 20, onOrderQty: 0, nextArrival: null, partCategory: "Mechanical Housings", finalProduct: "Widget Assembly B", monthlyLeadTimes: [7, 8, 7, 6, 7, 8]
            },
            {
                partNumber: "SCR-M5-20", description: "M5 Hex Screw 20mm", currentStock: 2340, safetyStock: 1000, leadTime: "3 days", moq: 5000, supplier: "FastenAll Inc", recommendedQty: 5000, status: "PO Required", price: 0.15, avgWeeklyConsumption: 250, onOrderQty: 0, nextArrival: null, partCategory: "Mechanical Housings", finalProduct: "Widget Assembly B", monthlyLeadTimes: [7, 8, 7, 6, 7, 8]
            },
            {
                partNumber: "WIR-022", description: "Electrical Wire 22AWG", currentStock: 890, safetyStock: 500, leadTime: "5 days", moq: 1000, supplier: "ElectroWire Corp", recommendedQty: 0, status: "Good", price: 0.45, avgWeeklyConsumption: 150, onOrderQty: 1000, nextArrival: '2024-03-10', partCategory: "Mechanical Housings", finalProduct: "Widget Assembly B", monthlyLeadTimes: [5, 5, 6, 5, 4, 5]
            }
        ];

        const mockSuppliers = [
            {
                id: "techcorp-industries", name: "TechCorp Industries", country: "Taiwan", onTimeDelivery: 94, avgLeadTime: 11.2, totalOrders: 48, lateDeliveries: 3, parts: ["PCB-001", "PCB-002", "LCD-15", "SEN-004"], rating: 4.7, ratingChange: 0.2, totalSpend: { '3m': 250000, '6m': 520000, '12m': 1100000 }, partAcceptanceRate: 99.8
            },
            {
                id: "mechparts-ltd", name: "MechParts Ltd", country: "Germany", onTimeDelivery: 87, avgLeadTime: 18.5, totalOrders: 32, lateDeliveries: 4, parts: ["MTR-205", "GBX-101", "SHF-034"], rating: 4.2, ratingChange: -0.1, totalSpend: { '3m': 480000, '6m': 950000, '12m': 1800000 }, partAcceptanceRate: 98.5
            },
            {
                id: "globalsupply-co", name: "GlobalSupply Co", country: "China", onTimeDelivery: 91, avgLeadTime: 8.3, totalOrders: 67, lateDeliveries: 6, parts: ["BRG-034", "BRG-025", "WSH-012", "SPR-008"], rating: 3.8, ratingChange: -0.4, totalSpend: { '3m': 120000, '6m': 260000, '12m': 550000 }, partAcceptanceRate: 99.1
            },
            {
                id: "fastenall-inc", name: "FastenAll Inc", country: "USA", onTimeDelivery: 98, avgLeadTime: 2.1, totalOrders: 24, lateDeliveries: 1, parts: ["SCR-M5-20", "SCR-M6-25", "NUT-M5", "WSH-M5"], rating: 4.9, ratingChange: 0.1, totalSpend: { '3m': 80000, '6m': 150000, '12m': 320000 }, partAcceptanceRate: 99.9
            },
            {
                id: "electrowire-corp", name: "ElectroWire Corp", country: "Malaysia", onTimeDelivery: 89, avgLeadTime: 6.7, totalOrders: 19, lateDeliveries: 2, parts: ["WIR-022", "WIR-018", "CBL-USB", "CON-024"], rating: 4.4, ratingChange: 0.0, totalSpend: { '3m': 65000, '6m': 140000, '12m': 290000 }, partAcceptanceRate: 99.3
            }
        ];

        const mockLeadTimeData = {
          "Critical A-Grade Parts": [8.5, 8.2, 8.0, 7.9, 7.5, 7.2],
          "Processors": [14.1, 14.5, 14.2, 13.8, 13.5, 13.9],
          "Motors": [21.0, 20.5, 21.2, 21.5, 20.8, 20.4],
          "Mechanical Housings": [5.2, 5.0, 5.1, 5.3, 5.5, 5.4]
        };

        // Navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');

            const updateActivePage = () => {
                const hash = window.location.hash || '#overview';
                const targetPageId = hash.substring(1);
                    
                    // Update active nav link
                navLinks.forEach(nav => {
                    nav.classList.toggle('active', nav.getAttribute('href') === hash);
                });
                    
                    // Show target page
                pages.forEach(page => {
                    page.classList.toggle('active', page.id === targetPageId);
                });
                    
                    // Initialize page-specific content
                if (targetPageId === 'overview') {
                        generateCalendarGrid();
                } else if (targetPageId === 'parts') {
                        populatePartsTable();
                } else if (targetPageId === 'suppliers') {
                        populateSupplierCards();
                } else if (targetPageId === 'analytics') {
                        setTimeout(() => initializeCharts(), 100);
                        initLeadTimeFilters();
                    }
            };

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    // Let the default hash change handle the navigation
                });
            });

            window.addEventListener('hashchange', updateActivePage);

            // Initial page load
            updateActivePage();

            // Hook up supplier page filters
            document.querySelector('#suppliers .filters select[aria-label="Time Period"]')?.addEventListener('change', populateSupplierCards);
        });

        // Calendar Functions
        let currentMonthIndex = 0;
        const months = [
            "January 2024", "February 2024", "March 2024", "April 2024",
            "May 2024", "June 2024", "July 2024", "August 2024"
        ];

        // --- Replace calendar grid with Weekly Status Grid ---
        function generateCalendarGrid() {
            // Remove old weeks table if present
            const grid = document.getElementById('weeklyStatusGrid');
            grid.innerHTML = '';
            // Example stub data for 12 weeks
            const weeks = [
                { week: 1, status: 'on-track', details: '3 POs pending', date: '2024-01-01' },
                { week: 2, status: 'on-track', details: 'All on track', date: '2024-01-08' },
                { week: 3, status: 'at-risk', details: '2 parts at risk', date: '2024-01-15', issue: '2 parts at risk' },
                { week: 4, status: 'on-track', details: 'All on track', date: '2024-01-22' },
                { week: 5, status: 'critical', details: 'Motor shortage', date: '2024-01-29', issue: 'Motor shortage' },
                { week: 6, status: 'at-risk', details: '1 PO delayed', date: '2024-02-05', issue: '1 PO delayed' },
                { week: 7, status: 'on-track', details: 'All on track', date: '2024-02-12' },
                { week: 8, status: 'on-track', details: '2 POs placed', date: '2024-02-19' },
                { week: 9, status: 'at-risk', details: 'PCB low stock', date: '2024-02-26', issue: 'PCB low stock' },
                { week: 10, status: 'on-track', details: 'All on track', date: '2024-03-04' },
                { week: 11, status: 'on-track', details: 'All on track', date: '2024-03-11' },
                { week: 12, status: 'at-risk', details: '3 POs needed', date: '2024-03-18', issue: '3 POs needed' }
            ];
            weeks.forEach(week => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `week-tile ${week.status}`;
                btn.setAttribute('data-week', week.week);
                btn.setAttribute('data-week-start', week.date);
                btn.setAttribute('aria-haspopup', 'dialog');
                btn.tabIndex = 0;
                btn.setAttribute('aria-label',
                  `Open details for Week ${week.week} – ${week.status === 'critical' ? 'Critical Risk' : week.status === 'at-risk' ? 'At Risk' : 'On Track'}`);
                btn.innerHTML = `
                  <span class="week-label">
                    <span class="week-num">Week ${week.week}</span>
                    <span class="week-date">${formatDate(week.date)}</span>
                  </span>
                  <span class="status-pill">${week.status === 'on-track' ? 'On Track' : week.status === 'at-risk' ? 'At Risk' : 'Critical'}</span>
                  ${week.status !== 'on-track' ? `<span class="issue-icon" title="${week.issue || week.details}" aria-label="${week.issue || week.details}">🛠</span>` : ''}
                `;
                if (week.status !== 'on-track') {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation(); // <-- Add this line
                        openModal(btn, week);
                    });
                    btn.addEventListener('keydown', e => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            openModal(btn, week);
                        }
                    });
                }
                grid.appendChild(btn);
            });
        }
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        // Debounce utility
        const debounce = (fn, wait=150) => {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        };
        window.addEventListener('resize', debounce(() => {
            // Scaffold: recalc grid cols if needed in future
        }, 150));
        // --- Modal logic ---
        let weekModalEl = null, originBtn = null;

        function hideWeekModal() {
            if (weekModalEl) weekModalEl.style.display = 'none';
            if (originBtn) {
                originBtn.focus();
                originBtn = null;
            }
        }

        function openModal(btn, week) {
            // --- GUARD CLAUSE ---
            // If the function is not called with a valid button element and a week object,
            // it means it was triggered by a rogue listener. Stop immediately.
            if (!btn || !week || typeof week.week === 'undefined') {
                console.warn("Ignoring invalid call to openModal().", { btn, week });
                return;
            }
            // --- END GUARD CLAUSE ---
            originBtn = btn;

            // Singleton modal creation & one-time binding
            if (!weekModalEl) {
                const tpl = document.getElementById('weekModalTemplate');
                document.body.appendChild(tpl.content.cloneNode(true));
                weekModalEl = document.getElementById('weekModal');

                if (weekModalEl.dataset.bound !== 'true') {
                    // Dismissal logic
                    weekModalEl.querySelectorAll('[data-dismiss="modal"]').forEach(el => el.onclick = hideWeekModal);
                    weekModalEl.addEventListener('click', (event) => {
                        if (event.target === event.currentTarget) hideWeekModal();
                    });

                    // Focus trap & Esc key
                    const focusable = [...weekModalEl.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')];
                    const first = focusable[0];
                    const last = focusable[focusable.length - 1];

                    function trap(e) {
                        if (e.key === 'Escape') {
                            hideWeekModal();
                            return;
                        }
                        if (e.key !== 'Tab' || !last) return; // a modal with no focusable elements
                        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                        if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                    }
                    weekModalEl.addEventListener('keydown', trap);
                    weekModalEl.dataset.bound = 'true';
                }
            }
            
            // Dynamic content refresh
            const riskLevel = week.status.charAt(0).toUpperCase() + week.status.slice(1).replace('-', ' ');
            weekModalEl.querySelector('#modalTitle').textContent = `Week ${week.week} Details: ${riskLevel}`;

            // Root-cause table with sort, highlight, deep links
            const stubRows = [
                { partId: 'PCB-001', supplier: 'TechCorp Industries', supplierEmail: 'sales@techcorp.com', shortfall: 75, po: 'PO-1001' },
                { partId: 'MTR-205', supplier: 'MechParts Ltd', supplierEmail: 'orders@mechparts.de', shortfall: 22, po: 'PO-1002' },
                { partId: 'BRG-034', supplier: 'GlobalSupply Co', supplierEmail: 'supply@globalsupply.cn', shortfall: 50, po: 'PO-1003' }
            ];

            const table = document.createElement('table');
            table.className = 'root-cause';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Part #</th>
                        <th>Supplier</th>
                        <th>Shortfall</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                ${stubRows.map(row => `
                    <tr>
                        <td><a href="#">${row.partId}</a></td>
                        <td><a href="#">${row.supplier}</a></td>
                        <td class="shortfall negative">${row.shortfall}</td>
                        <td class="actions-cell">
                            <a href="/po.html?id=${row.po}" class="btn btn-primary btn-sm" aria-label="View PO ${row.po}">View PO</a>
                            <a href="mailto:${row.supplierEmail}" class="btn btn-secondary btn-sm" aria-label="Contact supplier ${row.supplier}">Contact</a>
                        </td>
                    </tr>
                `).join('')}
                </tbody>
            `;
            
            const modalBody = weekModalEl.querySelector('.modal-body');
            modalBody.innerHTML = '';
            modalBody.appendChild(table);
            
            weekModalEl.style.display = 'flex';

            // Focus first element
            setTimeout(() => {
                const firstFocusable = weekModalEl.querySelector('button, [href]');
                if (firstFocusable) firstFocusable.focus();
            }, 50);
        }

        // Parts Table Functions
        function populatePartsTable() {
            const tbody = document.getElementById('partsTable');
            tbody.innerHTML = '';

            mockParts.forEach(part => {
                const row = document.createElement('tr');
                const statusClass = part.status === 'Critical' ? 'badge-danger' : 
                                  part.status === 'PO Required' ? 'badge-warning' : 'badge-success';
                
                row.innerHTML = `
                    <td><strong>${part.partNumber}</strong></td>
                    <td>${part.description}</td>
                    <td>${part.currentStock}</td>
                    <td>${part.safetyStock}</td>
                    <td>${part.leadTime}</td>
                    <td>${part.moq}</td>
                    <td>${part.supplier}</td>
                    <td>${part.status !== 'Good' ? part.recommendedQty : '—'}</td>
                    <td><span class="status-badge ${statusClass}">${part.status}</span></td>
                    <td>${part.weeksOfStock.toFixed(1)}</td>
                    <td>${part.onOrderQty}</td>
                    <td>${part.nextArrival ? formatDate(part.nextArrival) : '—'}</td>
                    <td>${renderPartActions(part)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Supplier Cards Functions
        function populateSupplierCards() {
            const container = document.getElementById('supplierCards');
            container.innerHTML = '';

            const timePeriodFilter = document.querySelector('#suppliers .filters select[aria-label="Time Period"]');
            const timePeriodKey = timePeriodFilter ? timePeriodFilter.value : '6m'; // e.g. '6m'

            mockSuppliers.forEach(supplier => {
                const card = document.createElement('div');
                
                let borderClass = 'border-primary';
                if (supplier.rating >= 4.5) borderClass = 'border-success';
                else if (supplier.rating < 4.0) borderClass = 'border-danger';
                card.className = `supplier-card ${borderClass}`;
                
                const stars = '★'.repeat(Math.floor(supplier.rating)) + 
                            (supplier.rating % 1 >= 0.5 ? '☆' : '');
                
                let trendClass = 'trend-neutral';
                let trendArrow = '';
                if (supplier.ratingChange > 0) {
                    trendClass = 'trend-up';
                    trendArrow = `↑${supplier.ratingChange.toFixed(1)}`;
                } else if (supplier.ratingChange < 0) {
                    trendClass = 'trend-down';
                    trendArrow = `↓${Math.abs(supplier.ratingChange).toFixed(1)}`;
                }

                const totalSpend = supplier.totalSpend[timePeriodKey] || 0;
                const formattedSpend = totalSpend > 1000000
                    ? `$${(totalSpend / 1000000).toFixed(1)}M`
                    : `$${(totalSpend / 1000).toFixed(0)}K`;
                
                card.innerHTML = `
                    <div>
                    <div class="supplier-header">
                        <div class="supplier-info">
                            <h3>${supplier.name}</h3>
                            <p><i class="fas fa-map-marker-alt"></i> ${supplier.country}</p>
                        </div>
                        <div class="supplier-rating">
                                <div class="rating-score">${supplier.rating.toFixed(1)}</div>
                            <div class="rating-stars">${stars}</div>
                                <div class="rating-trend ${trendClass}" aria-label="Rating change">${trendArrow}</div>
                        </div>
                    </div>
                    
                    <div class="supplier-metrics">
                        <div class="metric">
                            <div class="metric-value">${supplier.onTimeDelivery}%</div>
                            <div class="metric-label">On-Time Delivery</div>
                        </div>
                             <div class="metric">
                                <div class="metric-value">${supplier.partAcceptanceRate}%</div>
                                <div class="metric-label">Quality Score</div>
                            </div>
                        <div class="metric">
                            <div class="metric-value">${supplier.avgLeadTime}</div>
                            <div class="metric-label">Avg Lead Time (days)</div>
                        </div>
                            <div class="metric">
                                <div class="metric-value">${totalSpend > 0 ? formattedSpend : 'N/A'}</div>
                                <div class="metric-label">Total Spend (${timePeriodKey})</div>
                            </div>
                        <div class="metric">
                            <div class="metric-value">${supplier.totalOrders}</div>
                            <div class="metric-label">Total Orders</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${supplier.lateDeliveries}</div>
                            <div class="metric-label">Late Deliveries</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="supplier-card-footer">
                         <a href="supplier-detail.html?id=${supplier.id}" class="btn btn-primary" style="width: 100%;">View Details</a>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Charts Functions
        let leadTimeChartInstance, supplierChartInstance, inventoryChartInstance;
        function initializeCharts() {
            // Destroy existing charts to prevent memory leaks
            if(leadTimeChartInstance) leadTimeChartInstance.destroy();
            if(supplierChartInstance) supplierChartInstance.destroy();
            if(inventoryChartInstance) inventoryChartInstance.destroy();

            // Lead Time Trends Chart
            const leadTimeCtx = document.getElementById('leadTimeChart');
            if (leadTimeCtx) {
                leadTimeChartInstance = new Chart(leadTimeCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Average Lead Time (days)',
                            data: [], // Initially empty
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: false } }
                    }
                });
            }

            // Supplier Performance Chart
            const supplierCtx = document.getElementById('supplierChart');
            if (supplierCtx) {
                supplierChartInstance = new Chart(supplierCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Excellent (90%+)', 'Good (80-89%)', 'Needs Improvement (<80%)'],
                        datasets: [{
                            data: [60, 30, 10],
                            backgroundColor: ['#059669', '#d97706', '#dc2626']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            // Inventory Value Chart
            const inventoryCtx = document.getElementById('inventoryChart');
            if (inventoryCtx) {
                inventoryChartInstance = new Chart(inventoryCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Inventory Value ($K)',
                            data: [247, 251, 239, 244, 236, 231],
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
        }

        // --- Parts Planning State ---
        let selectedPartIds = new Set();
        let partsSortConfig = { key: 'weeksOfStock', dir: 1 }; // 1 for asc, -1 for desc

        // --- Parts Planning Functions ---
        function renderPartActions(part) {
            const actions = [];
            if (part.status === 'Critical' || part.status === 'PO Required') {
                actions.push(`<button class="btn btn-primary btn-sm">Create PO</button>`);
            }
            actions.push(`<button class="btn-icon-sm" title="View details" aria-label="View details for ${part.partNumber}" data-part-id="${part.partNumber}"><i class="fas fa-eye"></i></button>`);
            return `<div class="actions-cell">${actions.join('')}</div>`;
        }

        function updateBulkPOButton() {
            const btn = document.getElementById('bulkPOBtn');
            btn.disabled = selectedPartIds.size === 0;
        }

        function updateBulkActionsButton() {
            const container = document.getElementById('bulkActionsContainer');
            const btn = document.getElementById('bulkActionsBtn');
            if (!container || !btn) return;

            if (selectedPartIds.size > 0) {
                container.style.display = 'inline-block';
                btn.textContent = `Actions (${selectedPartIds.size})`;
            } else {
                container.style.display = 'none';
            }
        }

        function populatePartsTable() {
            const tbody = document.getElementById('partsTable');
            tbody.innerHTML = '';

            // Calculate weeks of stock
            mockParts.forEach(p => {
                p.weeksOfStock = p.avgWeeklyConsumption > 0 ? (p.currentStock / p.avgWeeklyConsumption) : 99;
            });

            // Sorting
            const sortedParts = [...mockParts].sort((a, b) => {
                const aVal = a[partsSortConfig.key];
                const bVal = b[partsSortConfig.key];
                if (aVal === null) return 1;
                if (bVal === null) return -1;
                if (aVal < bVal) return -1 * partsSortConfig.dir;
                if (aVal > bVal) return 1 * partsSortConfig.dir;
                return 0;
            });

            sortedParts.forEach(part => {
                const row = document.createElement('tr');
                const statusClass = part.status === 'Critical' ? 'badge-danger' : 
                                  part.status === 'PO Required' ? 'badge-warning' : 'badge-success';
                
                row.innerHTML = `
                    <td><input type="checkbox" class="part-select-checkbox" data-part-id="${part.partNumber}" ${selectedPartIds.has(part.partNumber) ? 'checked' : ''}></td>
                    <td><strong>${part.partNumber}</strong></td>
                    <td>${part.description}</td>
                    <td>${part.currentStock}</td>
                    <td>${part.safetyStock}</td>
                    <td>${part.leadTime}</td>
                    <td>${part.moq}</td>
                    <td>${part.supplier}</td>
                    <td>${part.status !== 'Good' ? part.recommendedQty : '—'}</td>
                    <td><span class="status-badge ${statusClass}">${part.status}</span></td>
                    <td>${part.weeksOfStock.toFixed(1)}</td>
                    <td>${part.onOrderQty}</td>
                    <td>${part.nextArrival ? formatDate(part.nextArrival) : '—'}</td>
                    <td>${renderPartActions(part)}</td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners after rows are in the DOM
            tbody.querySelectorAll('.part-select-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const partId = e.target.dataset.partId;
                    if (e.target.checked) {
                        selectedPartIds.add(partId);
                    } else {
                        selectedPartIds.delete(partId);
                    }
                    updateBulkPOButton();
                    updateBulkActionsButton();
                    updateSelectAllCheckboxState();
                });
            });

            tbody.querySelectorAll('.btn-icon-sm').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const partId = e.currentTarget.dataset.partId;
                    openPartDetailModal(partId);
                });
            });
        }
        
        function updateSelectAllCheckboxState() {
            const masterCheckbox = document.getElementById('selectAllPartsCheckbox');
            const visibleCheckboxes = [...document.querySelectorAll('#partsTable .part-select-checkbox')];
            const allVisibleSelected = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
            const someVisibleSelected = visibleCheckboxes.some(cb => cb.checked);

            masterCheckbox.checked = allVisibleSelected;
            masterCheckbox.indeterminate = !allVisibleSelected && someVisibleSelected;
        }

        document.getElementById('selectAllPartsCheckbox')?.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('#partsTable .part-select-checkbox').forEach(cb => {
                cb.checked = isChecked;
                const partId = cb.dataset.partId;
                if (isChecked) {
                    selectedPartIds.add(partId);
                } else {
                    selectedPartIds.delete(partId);
                }
            });
            updateBulkPOButton();
            updateBulkActionsButton();
        });

        document.querySelectorAll('.parts-table-container th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                if (partsSortConfig.key === key) {
                    partsSortConfig.dir *= -1;
                } else {
                    partsSortConfig.key = key;
                    partsSortConfig.dir = 1;
                }
                populatePartsTable();
            });
        });
        
        document.getElementById('bulkPOBtn')?.addEventListener('click', () => {
            if (selectedPartIds.size === 0) return;
            openBulkPOModal();
        });

        function openBulkPOModal() {
            if (!document.getElementById('bulkPOModal')) {
                 const tpl = document.getElementById('bulkPOModalTemplate');
                 document.body.appendChild(tpl.content.cloneNode(true));
            }
            const modal = document.getElementById('bulkPOModal');
            const tableBody = modal.querySelector('#bulkPOTable tbody');
            tableBody.innerHTML = '';

            const partsToOrder = mockParts.filter(p => selectedPartIds.has(p.partNumber));
            partsToOrder.forEach(part => {
                const row = `<tr>
                    <td>${part.partNumber}</td>
                    <td>${part.supplier}</td>
                    <td>${part.moq}</td>
                    <td>${part.currentStock}</td>
                    <td>${part.weeksOfStock.toFixed(1)}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
            
            modal.style.display = 'flex';
            
            // Prevent re-binding listeners
            if (modal.dataset.bound !== "true") {
                modal.querySelector('#confirmBulkPO').onclick = () => {
                    // TODO: Actual API call here
                    alert(`${selectedPartIds.size} Purchase Orders created successfully!`);
                    selectedPartIds.clear();
                    populatePartsTable();
                    updateBulkPOButton();
                    updateBulkActionsButton();
                    updateSelectAllCheckboxState();
                    closeModalById('bulkPOModal');
                };

                modal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                    btn.onclick = () => closeModalById('bulkPOModal');
                });
                modal.dataset.bound = "true";
            }
        }
        
        function openPartDetailModal(partNumber) {
            const part = mockParts.find(p => p.partNumber === partNumber);
            if (!part) return;

            if (!document.getElementById('partDetailModal')) {
                 const tpl = document.getElementById('partDetailModalTemplate');
                 document.body.appendChild(tpl.content.cloneNode(true));
            }
            const modal = document.getElementById('partDetailModal');
            
            modal.querySelector('#partDetailModalTitle').textContent = `${part.partNumber} - ${part.description}`;
            
            const recommendationText = part.status !== 'Good'
                ? `${part.status}: Order ${part.recommendedQty} units`
                : 'Stock sufficient. No order required.';
            const statusClass = part.status === 'Critical' ? 'badge-danger' :
                              part.status === 'PO Required' ? 'badge-warning' :
                              'badge-success';

            modal.querySelector('#partDetailModalBody').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 12px; color: #374151;">Current Inventory</h4>
                        <p><strong>Current Stock:</strong> ${part.currentStock} units</p>
                        <p><strong>Safety Stock:</strong> ${part.safetyStock} units</p>
                        <p><strong>Avg Weekly Consumption:</strong> ${part.avgWeeklyConsumption} units</p>
                        <p><strong>Weeks of Stock:</strong> ${part.weeksOfStock.toFixed(1)}</p>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 12px; color: #374151;">Supplier Information</h4>
                        <p><strong>Supplier:</strong> ${part.supplier}</p>
                        <p><strong>Lead Time:</strong> ${part.leadTime}</p>
                        <p><strong>MOQ:</strong> ${part.moq} units</p>
                        <p><strong>On Order:</strong> ${part.onOrderQty} units (ETA: ${part.nextArrival ? formatDate(part.nextArrival) : 'N/A'})</p>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 8px; color: #374151;">Configuration</h4>
                    <div style="display:flex; align-items:center; gap: 8px;">
                        <label for="partCategorySelector" style="font-weight: 500;">Part Category:</label>
                        <select id="partCategorySelector" class="filter-select" aria-label="Part Category selector">
                            <option value="unassigned">— unassigned —</option>
                            ${partCategories.map(cat => `<option value="${cat}" ${part.partCategory === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 8px; color: #374151;">Recommendation</h4>
                    <p><span class="status-badge ${statusClass}">${recommendationText}</span></p>
                </div>
            `;
            modal.style.display = 'flex';

            // Add listener for category change
            const categorySelector = modal.querySelector('#partCategorySelector');
            if (categorySelector) {
                categorySelector.addEventListener('change', function(e) {
                    const newCategory = e.target.value;
                    part.partCategory = newCategory === "unassigned" ? null : newCategory;
                    refreshPartDependentViews();
                });
            }

            // Prevent re-binding listeners
            if (modal.dataset.bound !== "true") {
                modal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                    btn.onclick = () => closeModalById('partDetailModal');
                });
                modal.dataset.bound = "true";
            }
        }
        
        function closeModalById(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function refreshPartDependentViews() {
            // Re-render the parts table to reflect any changes.
            populatePartsTable();

            // In a more complex app, this might emit a custom event
            // that other components (like the analytics dashboard) could listen for.
            // For now, the analytics page will re-init its filters when it becomes active.
            console.log('Part data changed. Dependent views refreshed.');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ManufacturingOS Demo Application Loaded');
        });

        // --- Lead Time Chart Functions ---
        const partCategories = [...new Set(mockParts.map(p => p.partCategory))].sort();
        const finalProducts = [...new Set(mockParts.map(p => p.finalProduct))].sort();

        function updateLeadTimeChart(groupType, groupValue) {
            const filteredParts = mockParts.filter(p => p[groupType] === groupValue);
            let aggregatedData = [0, 0, 0, 0, 0, 0];

            if (filteredParts.length > 0) {
                const monthlySums = [0, 0, 0, 0, 0, 0];
                filteredParts.forEach(part => {
                    part.monthlyLeadTimes.forEach((leadTime, monthIndex) => {
                        monthlySums[monthIndex] += leadTime;
                    });
                });
                aggregatedData = monthlySums.map(sum => sum / filteredParts.length);
            }

            leadTimeChartInstance.data.datasets[0].data = aggregatedData;
            leadTimeChartInstance.data.datasets[0].label = `Avg Lead Time for ${groupValue}`;
            leadTimeChartInstance.update();

            const announcer = document.getElementById('leadTimeAnnouncer');
            if (announcer) {
                announcer.textContent = `Lead-time trend updated for ${groupValue}.`;
            }
        }

        function initLeadTimeFilters() {
            const primarySelect = document.getElementById('leadTimePrimary');
            const secondarySelect = document.getElementById('leadTimeSecondary');
            const secondaryLabel = document.getElementById('leadTimeSecondaryLabel');

            function populateSecondary(dataSource, label, defaultValue) {
                secondarySelect.innerHTML = '';
                dataSource.forEach(item => {
                    const option = new Option(item, item);
                    secondarySelect.add(option);
                });
                secondarySelect.value = defaultValue;
                secondaryLabel.textContent = `Select ${label}:`;
            }

            primarySelect.addEventListener('change', function() {
                const selectedType = this.value;
                if (selectedType === 'partCategory') {
                    populateSecondary(partCategories, 'Category', partCategories[0]);
                } else {
                    populateSecondary(finalProducts, 'Product', finalProducts[0]);
                }
                updateLeadTimeChart(selectedType, secondarySelect.value);
            });

            secondarySelect.addEventListener('change', function() {
                updateLeadTimeChart(primarySelect.value, this.value);
            });

            // Initial population
            populateSecondary(partCategories, 'Category', 'Critical A-Grade Parts');
            updateLeadTimeChart('partCategory', 'Critical A-Grade Parts');
        }

        document.getElementById('bulkActionsBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('bulkActionsMenu');
            const btn = e.currentTarget;
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';

            if (isExpanded) {
                menu.style.display = 'none';
                btn.setAttribute('aria-expanded', 'false');
            } else {
                menu.style.display = 'block';
                btn.setAttribute('aria-expanded', 'true');
                // Optional: edge collision safeguard would go here
                menu.querySelector('button')?.focus(); // Focus first item
            }
        });

        function closeBulkActionsMenu() {
            const menu = document.getElementById('bulkActionsMenu');
            if (menu && menu.style.display !== 'none') {
                menu.style.display = 'none';
                document.getElementById('bulkActionsBtn')?.setAttribute('aria-expanded', 'false');
            }
        }

        document.addEventListener('click', closeBulkActionsMenu);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeBulkActionsMenu();
            }
        });

        document.getElementById('assignCategoryBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            closeBulkActionsMenu();
            openAssignCategoryModal();
        });

        function openAssignCategoryModal() {
            if (!document.getElementById('assignCategoryModal')) {
                 const tpl = document.getElementById('assignCategoryModalTemplate');
                 document.body.appendChild(tpl.content.cloneNode(true));
            }
            const modal = document.getElementById('assignCategoryModal');

            modal.querySelector('#assignCategoryModalTitle').textContent = `Assign Category to ${selectedPartIds.size} Parts`;
            const categorySelector = modal.querySelector('#bulkCategorySelector');
            categorySelector.innerHTML = partCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            modal.style.display = 'flex';

            if (modal.dataset.bound !== "true") {
                modal.querySelector('#applyCategoryBtn').onclick = () => {
                    const selectedCategory = categorySelector.value;
                    if (!partCategories.includes(selectedCategory)) {
                        alert("Error: The selected category no longer exists. Please refresh and try again.");
                        return;
                    }
                    
                    selectedPartIds.forEach(partId => {
                        const part = mockParts.find(p => p.partNumber === partId);
                        if (part) part.partCategory = selectedCategory;
                    });

                    selectedPartIds.clear();
                    refreshPartDependentViews();
                    updateBulkPOButton();
                    updateBulkActionsButton();
                    updateSelectAllCheckboxState();
                    closeModalById('assignCategoryModal');
                };

                modal.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                    btn.onclick = () => closeModalById('assignCategoryModal');
                });
                modal.dataset.bound = "true";
            }
        }
    </script>
</body>
</html>
